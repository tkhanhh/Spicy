local MacLib = { 
	Options = {}, 
	Folder = "ChilliLib", 
	GetService = function(service)
		return cloneref and cloneref(game:GetService(service)) or game:GetService(service)
	end
}

--// Services
local TweenService = MacLib.GetService("TweenService")
local RunService = MacLib.GetService("RunService")
local HttpService = MacLib.GetService("HttpService")
local UserInputService = MacLib.GetService("UserInputService")
local Players = MacLib.GetService("Players")
local CoreGui = MacLib.GetService("CoreGui")

--// Variables
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

--// Chilli Finder Theme Palette
local THEME = {
	Background    = Color3.fromRGB(16, 24, 39),
	CardGrad1     = Color3.fromRGB(12, 18, 32),
	CardGrad2     = Color3.fromRGB(21, 30, 47),
	CardGrad3     = Color3.fromRGB(10, 82, 120),
	StrokeGlow    = Color3.fromRGB(56, 189, 248),
	StrokeMain    = Color3.fromRGB(56, 189, 248),
	Surface       = Color3.fromRGB(30, 41, 59),
	SurfaceDark   = Color3.fromRGB(25, 32, 48),
	Accent        = Color3.fromRGB(52, 180, 230),
	Text          = Color3.fromRGB(241, 245, 249),
	TextMuted     = Color3.fromRGB(148, 163, 184),
	Error         = Color3.fromRGB(239, 68, 68),
	FontBold      = Enum.Font.GothamBold,
	FontSemi      = Enum.Font.GothamMedium,
	FontNormal    = Enum.Font.Gotham,
}

local IconList

--// Helper Functions
local function GetGui()
	local newGui = Instance.new("ScreenGui")
	newGui.Name = "ChilliLibUI"
	newGui.ScreenInsets = Enum.ScreenInsets.None
	newGui.ResetOnSpawn = false
	newGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	newGui.DisplayOrder = 10000

	local parent = RunService:IsStudio() 
		and LocalPlayer:FindFirstChild("PlayerGui")
		or (gethui and gethui())
		or CoreGui

	newGui.Parent = parent
	return newGui
end

local function Tween(instance, info, props)
	if not instance then return end
	local t = TweenService:Create(instance, info, props)
	t:Play()
	return t
end

-- Gradient Card Style Helper
local function AddCardStyle(frame, cornerRadius)
	frame.BackgroundColor3 = THEME.Background
	frame.BorderSizePixel = 0

	local corner = Instance.new("UICorner", frame)
	corner.CornerRadius = UDim.new(0, cornerRadius or 16)

	local grad = Instance.new("UIGradient", frame)
	grad.Rotation = 35
	grad.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0.00, THEME.CardGrad1),
		ColorSequenceKeypoint.new(0.55, THEME.CardGrad2),
		ColorSequenceKeypoint.new(1.00, THEME.CardGrad3),
	})

	local strokeGlow = Instance.new("UIStroke", frame)
	strokeGlow.Thickness = 3
	strokeGlow.Transparency = 0.8
	strokeGlow.Color = THEME.StrokeGlow
	strokeGlow.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

	local strokeMain = Instance.new("UIStroke", frame)
	strokeMain.Thickness = 1
	strokeMain.Transparency = 0.5
	strokeMain.Color = THEME.StrokeMain
	strokeMain.ApplyStrokeMode = Enum.ApplyStrokeMode.Border

	return strokeMain
end

local function AddGradient(instance)
	local g = Instance.new("UIGradient", instance)
	g.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 211, 238)),
		ColorSequenceKeypoint.new(1.00, Color3.fromRGB(99, 102, 241)),
	})
	g.Rotation = 45
	return g
end

-- Icon Loader
local function gl(i)
	if not IconList then
		pcall(function()
			IconList = loadstring(game:HttpGet('https://raw.githubusercontent.com/Dummyrme/Library/refs/heads/main/Icon.lua'))()
		end)
	end

	if IconList and IconList.Icons and IconList.Icons[i] then
		local iconData = IconList.Icons[i]
		local spriteSheet = IconList.Spritesheets[tostring(iconData.Image)]
		return { Image = spriteSheet, ImageRectSize = iconData.ImageRectSize, ImageRectPosition = iconData.ImageRectPosition }
	end

	return { Image = "rbxassetid://" .. tostring(i):gsub("rbxassetid://", ""), ImageRectSize = Vector2.new(0,0), ImageRectPosition = Vector2.new(0,0) }
end

--// Library Functions
function MacLib:Window(Settings)
	local WindowFunctions = {Settings = Settings}
	local macLib = GetGui()

	--// NOTIFICATIONS //--
	local notifications = Instance.new("Frame")
	notifications.Name = "Notifications"
	notifications.BackgroundTransparency = 1
	notifications.Size = UDim2.new(0, 280, 1, -20)
	notifications.Position = UDim2.new(1, -300, 0, 10)
	notifications.AnchorPoint = Vector2.new(0, 0)
	notifications.Parent = macLib
	notifications.ZIndex = 100

	local notifLayout = Instance.new("UIListLayout")
	notifLayout.Padding = UDim.new(0, 8)
	notifLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
	notifLayout.SortOrder = Enum.SortOrder.LayoutOrder
	notifLayout.VerticalAlignment = Enum.VerticalAlignment.Bottom
	notifLayout.Parent = notifications

	--// MAIN WINDOW (Reduced Size) //--
	-- Default size reduced ~15% from typical 700x450 to ~600x380
	local MainSize = Settings.Size or UDim2.fromOffset(580, 380)

	local base = Instance.new("CanvasGroup") -- CanvasGroup for smooth opacity fade
	base.Name = "MainBase"
	base.AnchorPoint = Vector2.new(0.5, 0.5)
	base.Position = UDim2.fromScale(0.5, 0.5)
	base.Size = MainSize
	base.Parent = macLib
	base.GroupTransparency = 0
	base.ClipsDescendants = false

	AddCardStyle(base, 16)

	-- Dragging Logic
	local dragging, dragInput, dragStart, startPos
	base.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = base.Position
			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then dragging = false end
			end)
		end
	end)
	base.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			dragInput = input
		end
	end)
	UserInputService.InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			local delta = input.Position - dragStart
			Tween(base, TweenInfo.new(0.05), {Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)})
		end
	end)

	-- Opening Animation
	base.GroupTransparency = 1
	base.Size = UDim2.new(0, MainSize.X.Offset * 0.9, 0, MainSize.Y.Offset * 0.9)
	Tween(base, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {GroupTransparency = 0, Size = MainSize})

	--// TOGGLE VISIBILITY LOGIC //--
	local isVisible = true
	local function ToggleUI()
		isVisible = not isVisible
		if isVisible then
			base.Visible = true
			Tween(base, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {GroupTransparency = 0, Size = MainSize})
		else
			local t = Tween(base, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {GroupTransparency = 1, Size = UDim2.new(0, MainSize.X.Offset * 0.9, 0, MainSize.Y.Offset * 0.9)})
			t.Completed:Connect(function()
				if not isVisible then base.Visible = false end
			end)
		end
	end

	UserInputService.InputBegan:Connect(function(input, gpe)
		if not gpe and input.KeyCode == Enum.KeyCode.LeftControl then
			ToggleUI()
		end
	end)

	--// TOPBAR (Reduced Height) //--
	local topBar = Instance.new("Frame")
	topBar.Name = "TopBar"
	topBar.Parent = base
	topBar.BackgroundColor3 = THEME.SurfaceDark
	topBar.BackgroundTransparency = 0.3
	topBar.BorderSizePixel = 0
	topBar.Size = UDim2.new(1, -16, 0, 38) -- Height reduced to 38
	topBar.Position = UDim2.new(0, 8, 0, 8)

	local topBarCorner = Instance.new("UICorner", topBar)
	topBarCorner.CornerRadius = UDim.new(0, 10)

	local titleLbl = Instance.new("TextLabel")
	titleLbl.Parent = topBar
	titleLbl.BackgroundTransparency = 1
	titleLbl.Position = UDim2.new(0, 12, 0, 0)
	titleLbl.Size = UDim2.new(1, -100, 1, 0)
	titleLbl.Font = THEME.FontBold
	titleLbl.Text = Settings.Title or "Chilli Interface"
	titleLbl.TextXAlignment = Enum.TextXAlignment.Left
	titleLbl.TextSize = 18
	titleLbl.TextColor3 = THEME.Text

	local titleGrad = Instance.new("UIGradient", titleLbl)
	titleGrad.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 211, 238)),
		ColorSequenceKeypoint.new(0.50, Color3.fromRGB(255, 255, 255)),
		ColorSequenceKeypoint.new(1.00, Color3.fromRGB(99, 102, 241)),
	})

	-- Hide Button ("X")
	local closeBtn = Instance.new("TextButton", topBar)
	closeBtn.Size = UDim2.fromOffset(26, 26)
	closeBtn.Position = UDim2.new(1, -36, 0.5, -13)
	closeBtn.BackgroundColor3 = THEME.Surface
	closeBtn.Text = "X"
	closeBtn.Font = THEME.FontBold
	closeBtn.TextSize = 14
	closeBtn.TextColor3 = THEME.Error
	closeBtn.AutoButtonColor = true

	local closeCorn = Instance.new("UICorner", closeBtn)
	closeCorn.CornerRadius = UDim.new(0, 6)
	local closeStroke = Instance.new("UIStroke", closeBtn)
	closeStroke.Color = THEME.StrokeMain
	closeStroke.Transparency = 0.7
	closeStroke.Thickness = 1

	closeBtn.MouseButton1Click:Connect(function()
		ToggleUI() -- Just hide, don't destroy
	end)

	--// CONTENT AREA //--
	local contentArea = Instance.new("Frame", base)
	contentArea.BackgroundColor3 = Color3.fromRGB(0,0,0)
	contentArea.BackgroundTransparency = 1
	contentArea.Position = UDim2.new(0, 8, 0, 54) -- Adjusted for new topbar
	contentArea.Size = UDim2.new(1, -16, 1, -62)

	--// SIDEBAR (Tabs) - Reduced Width //--
	local sideBar = Instance.new("ScrollingFrame", contentArea)
	sideBar.Size = UDim2.new(0, 130, 1, 0) -- Width reduced to 130
	sideBar.BackgroundTransparency = 1
	sideBar.ScrollBarThickness = 0
	sideBar.BorderSizePixel = 0
	sideBar.CanvasSize = UDim2.new(0,0,0,0)
	sideBar.AutomaticCanvasSize = Enum.AutomaticSize.Y

	local sideList = Instance.new("UIListLayout", sideBar)
	sideList.Padding = UDim.new(0, 6)
	sideList.SortOrder = Enum.SortOrder.LayoutOrder

	local sep = Instance.new("Frame", contentArea)
	sep.Size = UDim2.new(0, 1, 1, 0)
	sep.Position = UDim2.new(0, 138, 0, 0)
	sep.BackgroundColor3 = THEME.StrokeMain
	sep.BackgroundTransparency = 0.8
	sep.BorderSizePixel = 0

	local pages = Instance.new("Frame", contentArea)
	pages.Size = UDim2.new(1, -148, 1, 0)
	pages.Position = UDim2.new(0, 148, 0, 0)
	pages.BackgroundTransparency = 1
	pages.ClipsDescendants = true

	local currentTab = nil
	local tabButtons = {}

	--// Tab System
	function WindowFunctions:TabGroup()
		local GroupFuncs = {}
		function GroupFuncs:Tab(TabSettings)
			local TabFuncs = {}

			-- Tab Button
			local tabBtn = Instance.new("TextButton", sideBar)
			tabBtn.Size = UDim2.new(1, 0, 0, 32)
			tabBtn.BackgroundColor3 = THEME.Accent
			tabBtn.BackgroundTransparency = 1
			tabBtn.Text = ""
			tabBtn.AutoButtonColor = false

			local tabCorner = Instance.new("UICorner", tabBtn)
			tabCorner.CornerRadius = UDim.new(0, 6)

			-- Gradient for active tab
			local tabGrad = Instance.new("UIGradient", tabBtn)
			tabGrad.Color = ColorSequence.new({
				ColorSequenceKeypoint.new(0.00, THEME.CardGrad3),
				ColorSequenceKeypoint.new(1.00, THEME.CardGrad2)
			})
			tabGrad.Rotation = 0
			tabGrad.Enabled = false

			-- Vertical Selection Bar
			local selBar = Instance.new("Frame", tabBtn)
			selBar.Size = UDim2.new(0, 3, 0.7, 0)
			selBar.Position = UDim2.new(0, 2, 0.15, 0)
			selBar.BackgroundColor3 = THEME.Accent
			selBar.BackgroundTransparency = 1 -- Hidden by default
			Instance.new("UICorner", selBar).CornerRadius = UDim.new(1,0)

			local tabIcon = Instance.new("ImageLabel", tabBtn)
			tabIcon.Size = UDim2.fromOffset(18, 18)
			tabIcon.Position = UDim2.new(0, 12, 0.5, -9) -- Shifted left
			tabIcon.BackgroundTransparency = 1
			tabIcon.ImageColor3 = THEME.TextMuted

			if TabSettings.Image then
				local idata = gl(TabSettings.Image)
				tabIcon.Image = idata.Image
				tabIcon.ImageRectOffset = idata.ImageRectPosition
				tabIcon.ImageRectSize = idata.ImageRectSize
			end

			local tabTitle = Instance.new("TextLabel", tabBtn)
			tabTitle.BackgroundTransparency = 1
			tabTitle.Position = UDim2.new(0, 36, 0, 0)
			tabTitle.Size = UDim2.new(1, -36, 1, 0)
			tabTitle.Font = THEME.FontSemi
			tabTitle.Text = TabSettings.Title or "Tab"
			tabTitle.TextSize = 13
			tabTitle.TextColor3 = THEME.TextMuted
			tabTitle.TextXAlignment = Enum.TextXAlignment.Left

			-- Page (ScrollingFrame)
			local pageFrame = Instance.new("ScrollingFrame", pages)
			pageFrame.Size = UDim2.fromScale(1,1)
			pageFrame.BackgroundTransparency = 1
			pageFrame.Visible = false
			pageFrame.ScrollBarThickness = 2
			pageFrame.ScrollBarImageColor3 = THEME.Accent
			pageFrame.BorderSizePixel = 0
			pageFrame.CanvasSize = UDim2.new(0,0,0,0)
			pageFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y

			local pageList = Instance.new("UIListLayout", pageFrame)
			pageList.Padding = UDim.new(0, 10)
			pageList.SortOrder = Enum.SortOrder.LayoutOrder

			local pagePad = Instance.new("UIPadding", pageFrame)
			pagePad.PaddingRight = UDim.new(0, 4)
			pagePad.PaddingBottom = UDim.new(0, 10)

			local function Activate()
				if currentTab == tabBtn then return end

				-- Deactivate old
				for btn, data in pairs(tabButtons) do
					Tween(btn, TweenInfo.new(0.2), {BackgroundTransparency = 1})
					data.Grad.Enabled = false
					Tween(data.Title, TweenInfo.new(0.2), {TextColor3 = THEME.TextMuted})
					Tween(data.Icon, TweenInfo.new(0.2), {ImageColor3 = THEME.TextMuted})
					Tween(data.Bar, TweenInfo.new(0.2), {BackgroundTransparency = 1})
					data.Page.Visible = false
				end

				-- Activate new
				currentTab = tabBtn
				pageFrame.Visible = true
				-- Fade In Page
				pageFrame.Position = UDim2.new(0, 15, 0, 0)
				Tween(pageFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = UDim2.new(0,0,0,0)})

				-- Style Button
				tabGrad.Enabled = true
				Tween(tabBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.2})
				Tween(selBar, TweenInfo.new(0.2), {BackgroundTransparency = 0})
				Tween(tabTitle, TweenInfo.new(0.2), {TextColor3 = Color3.new(1,1,1)})
				Tween(tabIcon, TweenInfo.new(0.2), {ImageColor3 = Color3.new(1,1,1)})
			end

			tabBtn.MouseButton1Click:Connect(Activate)
			tabButtons[tabBtn] = {Page = pageFrame, Title = tabTitle, Icon = tabIcon, Grad = tabGrad, Bar = selBar}

			if currentTab == nil then Activate() end

			function TabFuncs:Select() Activate() end

			function TabFuncs:Section(SecSettings)
				local SecFuncs = {}

				local section = Instance.new("Frame", pageFrame)
				section.BackgroundColor3 = THEME.SurfaceDark
				section.BackgroundTransparency = 0.5
				section.Size = UDim2.new(1, -2, 0, 0)
				section.AutomaticSize = Enum.AutomaticSize.Y
				section.ClipsDescendants = true

				local secCorner = Instance.new("UICorner", section)
				secCorner.CornerRadius = UDim.new(0, 10)

				-- Section Gradient
				local secGrad = Instance.new("UIGradient", section)
				secGrad.Color = ColorSequence.new({
					ColorSequenceKeypoint.new(0.00, THEME.CardGrad2),
					ColorSequenceKeypoint.new(1.00, THEME.CardGrad1)
				})
				secGrad.Rotation = 45

				local secStroke = Instance.new("UIStroke", section)
				secStroke.Color = THEME.StrokeMain
				secStroke.Transparency = 0.8
				secStroke.Thickness = 1

				-- Header Button (for collapsing)
				local headerBtn = Instance.new("TextButton", section)
				headerBtn.Size = UDim2.new(1, 0, 0, 32)
				headerBtn.BackgroundTransparency = 1
				headerBtn.Text = ""
				headerBtn.ZIndex = 2

				local headerLbl = Instance.new("TextLabel", headerBtn)
				headerLbl.Text = SecSettings.Title or "Section"
				headerLbl.Font = THEME.FontBold
				headerLbl.TextSize = 14
				headerLbl.TextColor3 = THEME.Accent -- Blue color
				headerLbl.Size = UDim2.new(1, -30, 1, 0)
				headerLbl.Position = UDim2.new(0, 10, 0, 0)
				headerLbl.BackgroundTransparency = 1
				headerLbl.TextXAlignment = Enum.TextXAlignment.Left

				local arrow = Instance.new("TextLabel", headerBtn)
				arrow.Text = "▼"
				arrow.TextColor3 = THEME.TextMuted
				arrow.BackgroundTransparency = 1
				arrow.Size = UDim2.new(0, 20, 1, 0)
				arrow.Position = UDim2.new(1, -25, 0, 0)
				arrow.TextSize = 12

				-- Container for elements
				local container = Instance.new("Frame", section)
				container.Size = UDim2.new(1, 0, 0, 0)
				container.Position = UDim2.new(0, 0, 0, 32)
				container.BackgroundTransparency = 1
				container.AutomaticSize = Enum.AutomaticSize.Y

				local secLayout = Instance.new("UIListLayout", container)
				secLayout.Padding = UDim.new(0, 6)
				secLayout.SortOrder = Enum.SortOrder.LayoutOrder
				secLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center

				local secPad = Instance.new("UIPadding", container)
				secPad.PaddingTop = UDim.new(0, 4)
				secPad.PaddingBottom = UDim.new(0, 10)
				secPad.PaddingLeft = UDim.new(0, 8)
				secPad.PaddingRight = UDim.new(0, 8)

				-- Collapsing Logic
				local collapsed = false
				headerBtn.MouseButton1Click:Connect(function()
					collapsed = not collapsed
					Tween(arrow, TweenInfo.new(0.3, Enum.EasingStyle.Quad), {Rotation = collapsed and -90 or 0})
					container.Visible = not collapsed
					-- Force layout update is handled by AutomaticSize, but usually requires a frame tick
				end)

				local function MakeElement(height)
					local el = Instance.new("Frame", container)
					el.Size = UDim2.new(1, 0, 0, height or 34)
					el.BackgroundColor3 = Color3.fromRGB(15, 20, 30)
					el.BackgroundTransparency = 0.6
					local elCorn = Instance.new("UICorner", el)
					elCorn.CornerRadius = UDim.new(0, 6)
					local elStr = Instance.new("UIStroke", el)
					elStr.Color = THEME.StrokeMain
					elStr.Transparency = 0.9
					return el
				end

				local function AddTitle(parent, text)
					local lbl = Instance.new("TextLabel", parent)
					lbl.Size = UDim2.new(1, -10, 1, 0)
					lbl.Position = UDim2.new(0, 10, 0, 0)
					lbl.BackgroundTransparency = 1
					lbl.Text = text or "Element"
					lbl.Font = THEME.FontSemi
					lbl.TextSize = 13
					lbl.TextColor3 = THEME.Text
					lbl.TextXAlignment = Enum.TextXAlignment.Left
					return lbl
				end

				-- [BUTTON]
				function SecFuncs:Button(BSettings, Flag)
					local btnCont = MakeElement(32)
					btnCont.BackgroundColor3 = THEME.Accent
					btnCont.BackgroundTransparency = 0.85

					local btn = Instance.new("TextButton", btnCont)
					btn.Size = UDim2.fromScale(1,1)
					btn.BackgroundTransparency = 1
					btn.Text = BSettings.Title or BSettings.Name or "Button"
					btn.Font = THEME.FontBold
					btn.TextColor3 = THEME.Accent
					btn.TextSize = 13

					btn.MouseButton1Click:Connect(function()
						task.spawn(function()
							if BSettings.Callback then 
								pcall(BSettings.Callback) 
							end
						end)
						Tween(btn, TweenInfo.new(0.1), {TextSize = 11})
						task.wait(0.1)
						Tween(btn, TweenInfo.new(0.1), {TextSize = 13})
					end)

					btn.MouseEnter:Connect(function() Tween(btnCont, TweenInfo.new(0.2), {BackgroundTransparency = 0.6}) end)
					btn.MouseLeave:Connect(function() Tween(btnCont, TweenInfo.new(0.2), {BackgroundTransparency = 0.85}) end)

					local Funcs = {Class = "Button"}
					function Funcs:SetTitle(t) btn.Text = t end
					if Flag then MacLib.Options[Flag] = Funcs end
					return Funcs
				end

				-- [TOGGLE]
				function SecFuncs:Toggle(TSettings, Flag)
					local togCont = MakeElement(34)
					AddTitle(togCont, TSettings.Title or TSettings.Name)

					local togBtn = Instance.new("TextButton", togCont)
					togBtn.Size = UDim2.fromScale(1,1)
					togBtn.BackgroundTransparency = 1
					togBtn.Text = ""

					local switchBg = Instance.new("Frame", togCont)
					switchBg.Size = UDim2.fromOffset(36, 18)
					switchBg.Position = UDim2.new(1, -44, 0.5, -9)
					switchBg.BackgroundColor3 = THEME.Surface
					Instance.new("UICorner", switchBg).CornerRadius = UDim.new(1, 0)

					local knob = Instance.new("Frame", switchBg)
					knob.Size = UDim2.fromOffset(14, 14)
					knob.Position = UDim2.new(0, 2, 0.5, -7)
					knob.BackgroundColor3 = THEME.Text
					Instance.new("UICorner", knob).CornerRadius = UDim.new(1, 0)

					local toggled = TSettings.Default or false
					local Funcs = {Class = "Toggle", Value = toggled}

					local function Update(state)
						toggled = state
						Funcs.Value = state
						if toggled then
							Tween(switchBg, TweenInfo.new(0.2), {BackgroundColor3 = THEME.Accent})
							Tween(knob, TweenInfo.new(0.2), {Position = UDim2.new(1, -16, 0.5, -7)})
						else
							Tween(switchBg, TweenInfo.new(0.2), {BackgroundColor3 = THEME.Surface})
							Tween(knob, TweenInfo.new(0.2), {Position = UDim2.new(0, 2, 0.5, -7)})
						end
						
						if TSettings.Callback then 
							task.spawn(function()
								pcall(TSettings.Callback, toggled) 
							end)
						end
					end

					-- Set initial state without firing callback logic if needed, or fire it.
					-- Manually update visual only first
					if toggled then
						switchBg.BackgroundColor3 = THEME.Accent
						knob.Position = UDim2.new(1, -16, 0.5, -7)
					end
					
					togBtn.MouseButton1Click:Connect(function() Update(not toggled) end)

					function Funcs:Set(v) Update(v) end
					if Flag then MacLib.Options[Flag] = Funcs end
					return Funcs
				end

				-- [SLIDER]
				function SecFuncs:Slider(SSettings, Flag)
					local slidCont = MakeElement(46)
					AddTitle(slidCont, SSettings.Title or SSettings.Name).Size = UDim2.new(1, -10, 0, 20)

					local valLbl = Instance.new("TextLabel", slidCont)
					valLbl.Size = UDim2.new(0, 50, 0, 20)
					valLbl.Position = UDim2.new(1, -60, 0, 0)
					valLbl.BackgroundTransparency = 1
					valLbl.Text = tostring(SSettings.Default or SSettings.Minimum)
					valLbl.TextColor3 = THEME.Accent
					valLbl.Font = THEME.FontBold
					valLbl.TextSize = 13
					valLbl.TextXAlignment = Enum.TextXAlignment.Right

					local slideBg = Instance.new("Frame", slidCont)
					slideBg.Size = UDim2.new(1, -20, 0, 4)
					slideBg.Position = UDim2.new(0, 10, 0, 30)
					slideBg.BackgroundColor3 = THEME.Surface
					Instance.new("UICorner", slideBg).CornerRadius = UDim.new(1, 0)

					local fill = Instance.new("Frame", slideBg)
					fill.Size = UDim2.new(0, 0, 1, 0)
					fill.BackgroundColor3 = THEME.Accent
					Instance.new("UICorner", fill).CornerRadius = UDim.new(1, 0)

					local head = Instance.new("Frame", fill)
					head.Size = UDim2.fromOffset(10, 10)
					head.Position = UDim2.new(1, -5, 0.5, -5)
					head.BackgroundColor3 = THEME.Text
					Instance.new("UICorner", head).CornerRadius = UDim.new(1, 0)

					local min, max = SSettings.Minimum or 0, SSettings.Maximum or 100
					local value = SSettings.Default or min
					local Funcs = {Class = "Slider", Value = value}

					local function Update(input)
						local sizeX = slideBg.AbsoluteSize.X
						local mousePos = (input.Position.X - slideBg.AbsolutePosition.X)
						local percent = math.clamp(mousePos / sizeX, 0, 1)
						value = math.floor(min + (max - min) * percent)
						Funcs.Value = value

						Tween(fill, TweenInfo.new(0.05), {Size = UDim2.new(percent, 0, 1, 0)})
						valLbl.Text = tostring(value)
						if SSettings.Callback then 
							task.spawn(function() pcall(SSettings.Callback, value) end)
						end
					end

					local percent = (value - min) / (max - min)
					fill.Size = UDim2.new(percent, 0, 1, 0)

					local dragging = false
					local btn = Instance.new("TextButton", slideBg)
					btn.Size = UDim2.fromScale(1,1)
					btn.BackgroundTransparency = 1
					btn.Text = ""

					btn.InputBegan:Connect(function(input)
						if input.UserInputType == Enum.UserInputType.MouseButton1 then
							dragging = true
							Update(input)
						end
					end)
					UserInputService.InputEnded:Connect(function(input)
						if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
					end)
					UserInputService.InputChanged:Connect(function(input)
						if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then Update(input) end
					end)

					function Funcs:Set(v)
						value = math.clamp(v, min, max)
						local p = (value - min) / (max - min)
						Tween(fill, TweenInfo.new(0.2), {Size = UDim2.new(p, 0, 1, 0)})
						valLbl.Text = tostring(value)
						if SSettings.Callback then 
							task.spawn(function() pcall(SSettings.Callback, value) end)
						end
					end
					if Flag then MacLib.Options[Flag] = Funcs end
					return Funcs
				end

				-- [DROPDOWN] (FIXED LAYOUT)
				function SecFuncs:Dropdown(DSettings, Flag)
					-- Structure: Container (AutoY) -> HeaderFrame (Fixed 34px) + OptionsFrame (AutoY, below)
					local dropCont = Instance.new("Frame", container)
					dropCont.BackgroundColor3 = Color3.fromRGB(15, 20, 30)
					dropCont.BackgroundTransparency = 0.6
					dropCont.Size = UDim2.new(1, 0, 0, 34) -- Initial height
					dropCont.AutomaticSize = Enum.AutomaticSize.Y
					
					local elCorn = Instance.new("UICorner", dropCont)
					elCorn.CornerRadius = UDim.new(0, 6)
					local elStr = Instance.new("UIStroke", dropCont)
					elStr.Color = THEME.StrokeMain
					elStr.Transparency = 0.9

					-- Header (Title + Selected + Arrow)
					local header = Instance.new("TextButton", dropCont)
					header.Size = UDim2.new(1, 0, 0, 34)
					header.BackgroundTransparency = 1
					header.Text = ""
					
					local title = Instance.new("TextLabel", header)
					title.Size = UDim2.new(0.5, 0, 1, 0)
					title.Position = UDim2.new(0, 10, 0, 0)
					title.BackgroundTransparency = 1
					title.Text = DSettings.Title or DSettings.Name
					title.Font = THEME.FontSemi
					title.TextSize = 13
					title.TextColor3 = THEME.Text
					title.TextXAlignment = Enum.TextXAlignment.Left

					local current = DSettings.Default or "..."
					local selLbl = Instance.new("TextLabel", header)
					selLbl.Size = UDim2.new(0.5, -30, 1, 0)
					selLbl.Position = UDim2.new(0.5, 0, 0, 0)
					selLbl.BackgroundTransparency = 1
					selLbl.Text = current
					selLbl.Font = THEME.FontNormal
					selLbl.TextColor3 = THEME.TextMuted
					selLbl.TextXAlignment = Enum.TextXAlignment.Right
					
					local arrow = Instance.new("TextLabel", header)
					arrow.Size = UDim2.new(0, 20, 1, 0)
					arrow.Position = UDim2.new(1, -25, 0, 0)
					arrow.BackgroundTransparency = 1
					arrow.Text = "▼"
					arrow.TextColor3 = THEME.TextMuted
					arrow.TextSize = 10

					-- Options Container
					local optFrame = Instance.new("Frame", dropCont)
					optFrame.Size = UDim2.new(1, -10, 0, 0)
					optFrame.Position = UDim2.new(0, 5, 0, 36)
					optFrame.BackgroundTransparency = 1
					optFrame.Visible = false
					optFrame.AutomaticSize = Enum.AutomaticSize.Y
					
					local optList = Instance.new("UIListLayout", optFrame)
					optList.Padding = UDim.new(0, 4)
					
					local expanded = false
					local Funcs = {Class = "Dropdown", Value = current}

					local function RefreshList()
						for _, c in pairs(optFrame:GetChildren()) do
							if c:IsA("TextButton") then c:Destroy() end
						end
						for _, opt in ipairs(DSettings.Options or {}) do
							local optBtn = Instance.new("TextButton", optFrame)
							optBtn.Size = UDim2.new(1, 0, 0, 24)
							optBtn.BackgroundColor3 = THEME.Surface
							optBtn.Text = opt
							optBtn.Font = THEME.FontNormal
							optBtn.TextColor3 = THEME.Text
							optBtn.TextSize = 12
							Instance.new("UICorner", optBtn).CornerRadius = UDim.new(0, 4)

							optBtn.MouseButton1Click:Connect(function()
								current = opt
								Funcs.Value = opt
								selLbl.Text = opt
								expanded = false
								Tween(arrow, TweenInfo.new(0.3), {Rotation = 0})
								optFrame.Visible = false
								
								if DSettings.Callback then 
									task.spawn(function() pcall(DSettings.Callback, opt) end)
								end
							end)
						end
					end
					
					RefreshList()

					header.MouseButton1Click:Connect(function()
						expanded = not expanded
						Tween(arrow, TweenInfo.new(0.3), {Rotation = expanded and 180 or 0})
						optFrame.Visible = expanded
					end)

					function Funcs:Set(v)
						current = v
						selLbl.Text = v
					end
					function Funcs:Refresh(list)
						DSettings.Options = list
						RefreshList()
					end

					if Flag then MacLib.Options[Flag] = Funcs end
					return Funcs
				end

				-- [INPUT]
				function SecFuncs:Input(ISettings, Flag)
					local inpCont = MakeElement(34)
					AddTitle(inpCont, ISettings.Title or ISettings.Name)

					local boxBg = Instance.new("Frame", inpCont)
					boxBg.Size = UDim2.new(0, 100, 0, 22)
					boxBg.Position = UDim2.new(1, -110, 0.5, -11)
					boxBg.BackgroundColor3 = THEME.Background
					Instance.new("UICorner", boxBg).CornerRadius = UDim.new(0, 4)
					local bStr = Instance.new("UIStroke", boxBg)
					bStr.Color = THEME.StrokeMain
					bStr.Transparency = 0.8

					local box = Instance.new("TextBox", boxBg)
					box.Size = UDim2.new(1, -8, 1, 0)
					box.Position = UDim2.new(0, 4, 0, 0)
					box.BackgroundTransparency = 1
					box.Text = ISettings.Default or ""
					box.PlaceholderText = ISettings.Placeholder or "..."
					box.TextColor3 = THEME.Text
					box.Font = THEME.FontNormal
					box.TextSize = 12

					local Funcs = {Class = "Input", Value = box.Text}

					box.FocusLost:Connect(function()
						Funcs.Value = box.Text
						if ISettings.Callback then 
							task.spawn(function() pcall(ISettings.Callback, box.Text) end)
						end
					end)

					function Funcs:Set(t)
						box.Text = t
						Funcs.Value = t
					end
					if Flag then MacLib.Options[Flag] = Funcs end
					return Funcs
				end

				-- [LABEL]
				function SecFuncs:Label(Settings)
					local lbl = MakeElement(24)
					lbl.BackgroundTransparency = 1
					lbl.UIStroke:Destroy()
					AddTitle(lbl, Settings.Title or Settings.Name).Font = THEME.FontNormal
				end

				-- [PARAGRAPH] (Styled)
				function SecFuncs:Paragraph(Settings)
					local par = MakeElement(0) -- Auto size
					par.AutomaticSize = Enum.AutomaticSize.Y
					par.BackgroundTransparency = 0.7
					
					local pad = Instance.new("UIPadding", par)
					pad.PaddingTop = UDim.new(0, 8)
					pad.PaddingBottom = UDim.new(0, 8)
					pad.PaddingLeft = UDim.new(0, 8)
					pad.PaddingRight = UDim.new(0, 8)

					local title = Instance.new("TextLabel", par)
					title.Size = UDim2.new(1, 0, 0, 16)
					title.BackgroundTransparency = 1
					title.Text = Settings.Title or Settings.Header
					title.TextColor3 = THEME.Accent
					title.Font = THEME.FontBold
					title.TextSize = 13
					title.TextXAlignment = Enum.TextXAlignment.Left

					local desc = Instance.new("TextLabel", par)
					desc.Size = UDim2.new(1, 0, 0, 0)
					desc.Position = UDim2.new(0, 0, 0, 18)
					desc.AutomaticSize = Enum.AutomaticSize.Y
					desc.BackgroundTransparency = 1
					desc.Text = Settings.Desc or Settings.Body
					desc.TextColor3 = THEME.Text
					desc.TextSize = 12
					desc.TextWrapped = true
					desc.TextXAlignment = Enum.TextXAlignment.Left
					desc.Font = THEME.FontNormal
				end

				return SecFuncs
			end

			return TabFuncs
		end
		return GroupFuncs
	end

	--// NOTIFICATIONS (New System) //--
	function WindowFunctions:Notify(NSettings)
		local notif = Instance.new("Frame")
		notif.Size = UDim2.new(1, 0, 0, 60)
		notif.BackgroundTransparency = 1
		notif.Parent = notifications

		local card = Instance.new("Frame", notif)
		card.Size = UDim2.new(1, 0, 1, 0)
		card.Position = UDim2.new(1, 20, 0, 0) -- Start off screen
		
		AddCardStyle(card, 10)
		
		local nTitle = Instance.new("TextLabel", card)
		nTitle.Position = UDim2.new(0, 12, 0, 8)
		nTitle.Size = UDim2.new(1, -24, 0, 20)
		nTitle.BackgroundTransparency = 1
		nTitle.Font = THEME.FontBold
		nTitle.Text = NSettings.Title or "Notification"
		nTitle.TextColor3 = THEME.Accent
		nTitle.TextSize = 13
		nTitle.TextXAlignment = Enum.TextXAlignment.Left

		local nDesc = Instance.new("TextLabel", card)
		nDesc.Position = UDim2.new(0, 12, 0, 28)
		nDesc.Size = UDim2.new(1, -24, 0, 24)
		nDesc.BackgroundTransparency = 1
		nDesc.Font = THEME.FontNormal
		nDesc.Text = NSettings.Desc or "Description"
		nDesc.TextColor3 = THEME.Text
		nDesc.TextSize = 12
		nDesc.TextWrapped = true
		nDesc.TextXAlignment = Enum.TextXAlignment.Left
		nDesc.TextYAlignment = Enum.TextYAlignment.Top

		Tween(card, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Position = UDim2.new(0,0,0,0)})

		task.delay(NSettings.Duration or 3, function()
			local out = Tween(card, TweenInfo.new(0.5, Enum.EasingStyle.Quart, Enum.EasingDirection.In), {Position = UDim2.new(1, 20, 0, 0)})
			out.Completed:Connect(function() notif:Destroy() end)
		end)
	end

	function WindowFunctions:Unload()
		if WindowFunctions.onUnloadCallback then WindowFunctions.onUnloadCallback() end
		macLib:Destroy()
	end

	function WindowFunctions.onUnloaded(callback)
		WindowFunctions.onUnloadCallback = callback
	end

	return WindowFunctions
end

--// Config System (Restored)
function MacLib:SetFolder(Folder)
	MacLib.Folder = Folder
	if not isfolder(MacLib.Folder) then makefolder(MacLib.Folder) end
	if not isfolder(MacLib.Folder .. "/settings") then makefolder(MacLib.Folder .. "/settings") end
end

function MacLib:SaveConfig(Name)
	if not Name then return false, "No name" end
	local data = {}
	for flag, option in pairs(MacLib.Options) do
		if ClassParser[option.Class] then
			table.insert(data, ClassParser[option.Class].Save(flag, option))
		end
	end
	writefile(MacLib.Folder .. "/settings/" .. Name .. ".json", HttpService:JSONEncode(data))
	return true
end

function MacLib:LoadConfig(Name)
	if not isfile(MacLib.Folder .. "/settings/" .. Name .. ".json") then return false, "No file" end
	local data = HttpService:JSONDecode(readfile(MacLib.Folder .. "/settings/" .. Name .. ".json"))
	for _, option in pairs(data) do
		if ClassParser[option.type] then
			ClassParser[option.type].Load(option.flag, option)
		end
	end
	return true
end

function MacLib:RefreshConfigList()
	local list = listfiles(MacLib.Folder .. "/settings")
	local out = {}
	for _, file in pairs(list) do
		if file:sub(-5) == ".json" then
			local pos = file:find(".json", 1, true)
			local start = pos
			local char = file:sub(pos, pos)
			while char ~= "/" and char ~= "\\" and char ~= "" do
				pos = pos - 1
				char = file:sub(pos, pos)
			end
			if char == "/" or char == "\\" then
				table.insert(out, file:sub(pos + 1, start - 1))
			end
		end
	end
	return out
end

--// Demo
function MacLib:Demo()
	local Window = MacLib:Window({Title = "Chilli Interface"})
	local Group = Window:TabGroup()
	local Tab = Group:Tab({Title = "Main", Image = "rbxassetid://10709791437"})
	local Section = Tab:Section({Title = "Features"})

	Section:Toggle({Title = "Auto Farm", Default = false, Callback = function(v) print("Farm:", v) end}, "AutoFarm")
	Section:Slider({Title = "WalkSpeed", Default = 16, Minimum = 16, Maximum = 100, Callback = function(v) print("Speed:", v) end}, "WalkSpeed")
	Section:Dropdown({Title = "Target Mode", Options = {"Nearest", "Random"}, Default = "Nearest"}, "TargetMode")
	Section:Paragraph({Title = "Info", Desc = "This is a styled paragraph block."})
	Section:Button({Title = "Notify Me", Callback = function() Window:Notify({Title = "Success", Desc = "Action completed successfully!", Duration = 3}) end})

	MacLib:SetFolder("ChilliLib")
end

return MacLib
