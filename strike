local MacLib = { 
	Options = {}, 
	Folder = "ChilliLib", 
	GetService = function(service)
		return cloneref and cloneref(game:GetService(service)) or game:GetService(service)
	end
}

--// Services
local TweenService = MacLib.GetService("TweenService")
local RunService = MacLib.GetService("RunService")
local HttpService = MacLib.GetService("HttpService")
local UserInputService = MacLib.GetService("UserInputService")
local Players = MacLib.GetService("Players")
local CoreGui = MacLib.GetService("CoreGui")

--// Variables
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()
local ViewportSize = workspace.CurrentCamera.ViewportSize

--// Theme Palette (Chilli Finder Style)
local THEME = {
    Background    = Color3.fromRGB(16, 24, 39),      -- Nền chính tối
    CardGrad1     = Color3.fromRGB(12, 18, 32),
    CardGrad2     = Color3.fromRGB(21, 30, 47),
    CardGrad3     = Color3.fromRGB(10, 82, 120),     -- Xanh đậm góc
    SectionGrad1  = Color3.fromRGB(20, 30, 50),
    SectionGrad2  = Color3.fromRGB(30, 45, 70),
    StrokeGlow    = Color3.fromRGB(56, 189, 248),    -- Cyan Glow
    StrokeMain    = Color3.fromRGB(56, 189, 248),
    Surface       = Color3.fromRGB(30, 41, 59),
    SurfaceDark   = Color3.fromRGB(25, 32, 48),
    Accent        = Color3.fromRGB(52, 180, 230),    -- Màu nhấn chính
    Text          = Color3.fromRGB(241, 245, 249),
    TextMuted     = Color3.fromRGB(148, 163, 184),
    Error         = Color3.fromRGB(239, 68, 68),
    FontBold      = Enum.Font.GothamBold,
    FontSemi      = Enum.Font.GothamMedium,
    FontNormal    = Enum.Font.Gotham,
}

local IconList

--// Helper Functions
local function GetGui()
	local newGui = Instance.new("ScreenGui")
	newGui.Name = "ChilliLibUI_v2"
	newGui.ScreenInsets = Enum.ScreenInsets.None
	newGui.ResetOnSpawn = false
	newGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
	newGui.DisplayOrder = 10000

	local parent = RunService:IsStudio() 
		and LocalPlayer:FindFirstChild("PlayerGui")
		or (gethui and gethui())
		or CoreGui

	newGui.Parent = parent
	return newGui
end

local function Tween(instance, info, props)
    if not instance then return end
    local t = TweenService:Create(instance, info, props)
    t:Play()
    return t
end

local function SafeCallback(func, ...)
    if not func then return end
    local args = {...}
    task.spawn(function()
        local success, err = pcall(func, unpack(args))
        if not success then
            warn("[MacLib] Callback Error:", err)
        end
    end)
end

-- Gradient Style for Frames
local function AddGradient(frame, colors, rot)
    local g = Instance.new("UIGradient", frame)
    g.Rotation = rot or 0
    g.Color = ColorSequence.new(colors)
    return g
end

--// Library Functions
function MacLib:Window(Settings)
    local WindowFunctions = {Settings = Settings}
    local macLib = GetGui()
    
    local guiOpen = true
    
    -- Notifications Container
    local notifContainer = Instance.new("Frame")
    notifContainer.Name = "Notifications"
    notifContainer.BackgroundTransparency = 1
    notifContainer.Size = UDim2.new(0, 320, 1, -20)
    notifContainer.Position = UDim2.new(1, -330, 0, 10)
    notifContainer.Parent = macLib
    notifContainer.ZIndex = 1000

    local notifLayout = Instance.new("UIListLayout", notifContainer)
    notifLayout.Padding = UDim.new(0, 8)
    notifLayout.HorizontalAlignment = Enum.HorizontalAlignment.Right
    notifLayout.VerticalAlignment = Enum.VerticalAlignment.Bottom
    notifLayout.SortOrder = Enum.SortOrder.LayoutOrder

    -- Main Window Frame
    local base = Instance.new("Frame")
    base.Name = "MainBase"
    base.AnchorPoint = Vector2.new(0.5, 0.5)
    base.Position = UDim2.fromScale(0.5, 0.5)
    -- Giảm kích thước mặc định xuống ~15% so với bản cũ (700x450 -> 600x380)
    base.Size = Settings.Size or UDim2.fromOffset(600, 380)
    base.Parent = macLib
    base.ClipsDescendants = false
    base.BackgroundColor3 = THEME.Background
    
    -- Main Styling (Round + Glow + Gradient)
    Instance.new("UICorner", base).CornerRadius = UDim.new(0, 16)
    
    local baseGrad = AddGradient(base, {
        ColorSequenceKeypoint.new(0.00, THEME.CardGrad1),
        ColorSequenceKeypoint.new(0.55, THEME.CardGrad2),
        ColorSequenceKeypoint.new(1.00, THEME.CardGrad3),
    }, 45)

    local baseStroke = Instance.new("UIStroke", base)
    baseStroke.Thickness = 2
    baseStroke.Transparency = 0.5
    baseStroke.Color = THEME.StrokeGlow
    
    local shadow = Instance.new("ImageLabel", base)
    shadow.Name = "Shadow"
    shadow.AnchorPoint = Vector2.new(0.5, 0.5)
    shadow.Position = UDim2.fromScale(0.5, 0.5)
    shadow.Size = UDim2.new(1, 140, 1, 140)
    shadow.BackgroundTransparency = 1
    shadow.Image = "rbxassetid://6014261993"
    shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    shadow.ImageTransparency = 0.4
    shadow.ZIndex = -1
    shadow.SliceCenter = Rect.new(49, 49, 450, 450)
    shadow.ScaleType = Enum.ScaleType.Slice
    shadow.SliceScale = 1

    -- Dragging Logic
    local dragging, dragInput, dragStart, startPos
    base.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = base.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then dragging = false end
            end)
        end
    end)
    base.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            Tween(base, TweenInfo.new(0.05), {Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)})
        end
    end)

    -- TopBar (Giảm chiều cao 15% -> ~38px)
    local topBar = Instance.new("Frame", base)
    topBar.Name = "TopBar"
    topBar.BackgroundColor3 = THEME.SurfaceDark
    topBar.BackgroundTransparency = 0.4
    topBar.Size = UDim2.new(1, -16, 0, 38) 
    topBar.Position = UDim2.new(0, 8, 0, 8)
    Instance.new("UICorner", topBar).CornerRadius = UDim.new(0, 10)

    local titleLbl = Instance.new("TextLabel", topBar)
    titleLbl.BackgroundTransparency = 1
    titleLbl.Position = UDim2.new(0, 12, 0, 0)
    titleLbl.Size = UDim2.new(1, -100, 1, 0)
    titleLbl.Font = THEME.FontBold
    titleLbl.Text = Settings.Title or "Chilli Interface"
    titleLbl.TextXAlignment = Enum.TextXAlignment.Left
    titleLbl.TextSize = 18
    titleLbl.TextColor3 = THEME.Text
    
    -- Gradient Title
    local titleGrad = AddGradient(titleLbl, {
        ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 211, 238)),
        ColorSequenceKeypoint.new(0.50, Color3.fromRGB(255, 255, 255)),
        ColorSequenceKeypoint.new(1.00, Color3.fromRGB(99, 102, 241)),
    })

    -- Toggle GUI Logic (Hide/Show, not Destroy)
    local function ToggleWindow(state)
        if state == nil then state = not base.Visible end
        guiOpen = state
        
        if state then
            base.Visible = true
            base.Size = UDim2.new(0, 0, 0, 0) -- Start scale
            Tween(base, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
                Size = Settings.Size or UDim2.fromOffset(600, 380)
            })
        else
            local t = Tween(base, TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {
                Size = UDim2.new(0, 0, 0, 0)
            })
            t.Completed:Wait()
            base.Visible = false
        end
    end

    -- Close Button (X) - Just Hides
    local closeBtn = Instance.new("TextButton", topBar)
    closeBtn.Size = UDim2.fromOffset(26, 26)
    closeBtn.Position = UDim2.new(1, -34, 0.5, -13)
    closeBtn.BackgroundColor3 = THEME.Surface
    closeBtn.Text = "X"
    closeBtn.Font = THEME.FontBold
    closeBtn.TextSize = 14
    closeBtn.TextColor3 = THEME.Error
    closeBtn.AutoButtonColor = true
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)
    local closeStroke = Instance.new("UIStroke", closeBtn)
    closeStroke.Color = THEME.StrokeMain
    closeStroke.Transparency = 0.7
    closeStroke.Thickness = 1

    closeBtn.MouseButton1Click:Connect(function()
        ToggleWindow(false)
    end)

    -- Left Control Keybind
    UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        if input.KeyCode == Enum.KeyCode.LeftControl then
            ToggleWindow()
        end
    end)

    -- Content Area
    local contentArea = Instance.new("Frame", base)
    contentArea.BackgroundColor3 = Color3.fromRGB(0,0,0)
    contentArea.BackgroundTransparency = 1
    contentArea.Position = UDim2.new(0, 8, 0, 54) -- Offset topbar + spacing
    contentArea.Size = UDim2.new(1, -16, 1, -62)

    -- Sidebar (Tabs) - Giảm chiều ngang còn 130px
    local sideBar = Instance.new("ScrollingFrame", contentArea)
    sideBar.Size = UDim2.new(0, 130, 1, 0)
    sideBar.BackgroundTransparency = 1
    sideBar.ScrollBarThickness = 0
    sideBar.BorderSizePixel = 0
    sideBar.AutomaticCanvasSize = Enum.AutomaticSize.Y
    
    local sideList = Instance.new("UIListLayout", sideBar)
    sideList.Padding = UDim.new(0, 6)
    sideList.SortOrder = Enum.SortOrder.LayoutOrder

    -- Divider Line
    local div = Instance.new("Frame", contentArea)
    div.Size = UDim2.new(0, 1, 1, 0)
    div.Position = UDim2.new(0, 138, 0, 0)
    div.BackgroundColor3 = THEME.StrokeMain
    div.BackgroundTransparency = 0.8
    div.BorderSizePixel = 0

    -- Pages Container
    local pages = Instance.new("Frame", contentArea)
    pages.Size = UDim2.new(1, -148, 1, 0)
    pages.Position = UDim2.new(0, 148, 0, 0)
    pages.BackgroundTransparency = 1
    pages.ClipsDescendants = true

    local currentTabBtn = nil
    local tabs = {}

    --// Tab System
    function WindowFunctions:TabGroup()
        local GroupFuncs = {}
        function GroupFuncs:Tab(TabSettings)
            local TabFuncs = {}
            
            -- Tab Button Design
            local tabBtn = Instance.new("TextButton", sideBar)
            tabBtn.Size = UDim2.new(1, 0, 0, 34)
            tabBtn.BackgroundColor3 = THEME.Surface
            tabBtn.BackgroundTransparency = 1 -- Transparent default
            tabBtn.Text = ""
            tabBtn.AutoButtonColor = false
            
            Instance.new("UICorner", tabBtn).CornerRadius = UDim.new(0, 8)
            
            -- Gradient for Selected State (Hidden by default)
            local tabGrad = AddGradient(tabBtn, {
                ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 211, 238)),
                ColorSequenceKeypoint.new(1.00, Color3.fromRGB(99, 102, 241)),
            })
            tabGrad.Enabled = false 

            -- Indicator Bar (Thanh dọc bên trái)
            local indicator = Instance.new("Frame", tabBtn)
            indicator.Size = UDim2.new(0, 3, 0.6, 0)
            indicator.Position = UDim2.new(0, 0, 0.2, 0)
            indicator.BackgroundColor3 = THEME.Accent
            indicator.BorderSizePixel = 0
            indicator.Visible = false
            Instance.new("UICorner", indicator).CornerRadius = UDim.new(1, 0)

            local tabTitle = Instance.new("TextLabel", tabBtn)
            tabTitle.BackgroundTransparency = 1
            tabTitle.Position = UDim2.new(0, 12, 0, 0) -- Dịch sang trái chút
            tabTitle.Size = UDim2.new(1, -12, 1, 0)
            tabTitle.Font = THEME.FontSemi
            tabTitle.Text = TabSettings.Title or "Tab"
            tabTitle.TextSize = 13
            tabTitle.TextColor3 = THEME.TextMuted
            tabTitle.TextXAlignment = Enum.TextXAlignment.Left

            -- Page Frame
            local pageFrame = Instance.new("ScrollingFrame", pages)
            pageFrame.Size = UDim2.fromScale(1,1)
            pageFrame.BackgroundTransparency = 1
            pageFrame.Visible = false
            pageFrame.ScrollBarThickness = 2
            pageFrame.ScrollBarImageColor3 = THEME.Accent
            pageFrame.BorderSizePixel = 0
            pageFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
            
            local pageList = Instance.new("UIListLayout", pageFrame)
            pageList.Padding = UDim.new(0, 10)
            pageList.SortOrder = Enum.SortOrder.LayoutOrder
            
            Instance.new("UIPadding", pageFrame).PaddingBottom = UDim.new(0, 10)
            Instance.new("UIPadding", pageFrame).PaddingRight = UDim.new(0, 6)

            local function Activate()
                if currentTabBtn == tabBtn then return end
                
                -- Deactivate Old
                for _, t in pairs(tabs) do
                    Tween(t.Btn, TweenInfo.new(0.2), {BackgroundTransparency = 1})
                    t.Grad.Enabled = false
                    t.Ind.Visible = false
                    Tween(t.Lbl, TweenInfo.new(0.2), {TextColor3 = THEME.TextMuted})
                    t.Page.Visible = false
                end
                
                -- Activate New
                currentTabBtn = tabBtn
                pageFrame.Visible = true
                pageFrame.Position = UDim2.new(0, 15, 0, 0)
                Tween(pageFrame, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {Position = UDim2.new(0,0,0,0)})

                Tween(tabBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.8}) -- Light bg
                tabGrad.Enabled = true -- Gradient on
                indicator.Visible = true -- Bar on
                Tween(tabTitle, TweenInfo.new(0.2), {TextColor3 = THEME.Text})
            end

            tabBtn.MouseButton1Click:Connect(Activate)
            table.insert(tabs, {Btn = tabBtn, Grad = tabGrad, Ind = indicator, Lbl = tabTitle, Page = pageFrame})
            
            if #tabs == 1 then Activate() end

            function TabFuncs:Select() Activate() end

            --// SECTIONS
            function TabFuncs:Section(SecSettings)
                local SecFuncs = {}
                
                local section = Instance.new("Frame", pageFrame)
                section.BackgroundColor3 = THEME.Surface
                section.Size = UDim2.new(1, 0, 0, 0) -- Height calc later
                section.AutomaticSize = Enum.AutomaticSize.Y
                section.ClipsDescendants = true -- Important for smooth collapse
                
                Instance.new("UICorner", section).CornerRadius = UDim.new(0, 10)
                
                -- Gradient Section Background
                AddGradient(section, {
                    ColorSequenceKeypoint.new(0, THEME.SectionGrad1),
                    ColorSequenceKeypoint.new(1, THEME.SectionGrad2)
                }, 90)

                local secStroke = Instance.new("UIStroke", section)
                secStroke.Color = THEME.StrokeMain
                secStroke.Transparency = 0.8
                secStroke.Thickness = 1

                local contentContainer = Instance.new("Frame", section)
                contentContainer.Name = "Content"
                contentContainer.Size = UDim2.new(1, 0, 0, 0)
                contentContainer.Position = UDim2.new(0, 0, 0, 32) -- Below header
                contentContainer.BackgroundTransparency = 1
                contentContainer.AutomaticSize = Enum.AutomaticSize.Y

                local secLayout = Instance.new("UIListLayout", contentContainer)
                secLayout.Padding = UDim.new(0, 8)
                secLayout.SortOrder = Enum.SortOrder.LayoutOrder
                secLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
                
                local secPad = Instance.new("UIPadding", contentContainer)
                secPad.PaddingTop = UDim.new(0, 4)
                secPad.PaddingBottom = UDim.new(0, 10)
                secPad.PaddingLeft = UDim.new(0, 8)
                secPad.PaddingRight = UDim.new(0, 8)

                -- Header
                local headerBtn = Instance.new("TextButton", section)
                headerBtn.Size = UDim2.new(1, 0, 0, 32)
                headerBtn.BackgroundTransparency = 1
                headerBtn.Text = ""
                
                local titleLbl = Instance.new("TextLabel", headerBtn)
                titleLbl.Text = SecSettings.Title or "Section"
                titleLbl.Font = THEME.FontBold
                titleLbl.TextSize = 14
                titleLbl.TextColor3 = THEME.Accent
                titleLbl.Size = UDim2.new(1, -30, 1, 0)
                titleLbl.Position = UDim2.new(0, 10, 0, 0)
                titleLbl.BackgroundTransparency = 1
                titleLbl.TextXAlignment = Enum.TextXAlignment.Left
                
                local arrow = Instance.new("ImageLabel", headerBtn)
                arrow.Size = UDim2.fromOffset(16, 16)
                arrow.Position = UDim2.new(1, -26, 0.5, -8)
                arrow.BackgroundTransparency = 1
                arrow.Image = "rbxassetid://6034818372" -- Down arrow
                arrow.ImageColor3 = THEME.TextMuted

                -- Collapse Logic
                local collapsed = false
                local contentSize = 0
                
                -- Track content size changes
                secLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                    if not collapsed then
                        -- Update height automatically if expanded
                    end
                end)

                headerBtn.MouseButton1Click:Connect(function()
                    collapsed = not collapsed
                    local targetH = collapsed and 32 or (32 + contentContainer.AbsoluteSize.Y + 10)
                    
                    Tween(arrow, TweenInfo.new(0.3), {Rotation = collapsed and 180 or 0})
                    
                    -- Smooth Scroll Effect
                    -- Trick: Tween the size. AutomaticSize conflicts with Tweening, so disable it momentarily or rely on ClipsDescendants
                    if collapsed then
                        section.AutomaticSize = Enum.AutomaticSize.None
                        Tween(section, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, 32)})
                    else
                        -- Calculate target height
                        local h = contentContainer.AbsoluteSize.Y + 42
                        Tween(section, TweenInfo.new(0.3, Enum.EasingStyle.Quart, Enum.EasingDirection.Out), {Size = UDim2.new(1, 0, 0, h)})
                        task.delay(0.3, function()
                            if not collapsed then section.AutomaticSize = Enum.AutomaticSize.Y end
                        end)
                    end
                end)

                -- Helper to make elements
                local function MakeElement(h)
                    local el = Instance.new("Frame", contentContainer)
                    el.Size = UDim2.new(1, 0, 0, h or 36)
                    el.BackgroundColor3 = THEME.Background
                    el.BackgroundTransparency = 0.5
                    Instance.new("UICorner", el).CornerRadius = UDim.new(0, 6)
                    local s = Instance.new("UIStroke", el)
                    s.Color = THEME.StrokeMain
                    s.Transparency = 0.9
                    return el
                end

                local function AddTitle(p, t)
                    local l = Instance.new("TextLabel", p)
                    l.Text = t
                    l.Font = THEME.FontSemi
                    l.TextSize = 13
                    l.TextColor3 = THEME.Text
                    l.BackgroundTransparency = 1
                    l.Size = UDim2.new(1, -10, 1, 0)
                    l.Position = UDim2.new(0, 10, 0, 0)
                    l.TextXAlignment = Enum.TextXAlignment.Left
                    return l
                end

                -- [BUTTON]
                function SecFuncs:Button(BSettings)
                    local btnCont = MakeElement(34)
                    btnCont.BackgroundColor3 = THEME.Accent
                    btnCont.BackgroundTransparency = 0.9
                    
                    local btn = Instance.new("TextButton", btnCont)
                    btn.Size = UDim2.fromScale(1,1)
                    btn.BackgroundTransparency = 1
                    btn.Text = BSettings.Title or "Button"
                    btn.Font = THEME.FontBold
                    btn.TextSize = 13
                    btn.TextColor3 = THEME.Accent
                    
                    btn.MouseButton1Click:Connect(function()
                        SafeCallback(BSettings.Callback)
                        Tween(btn, TweenInfo.new(0.1), {TextSize = 11})
                        task.wait(0.1)
                        Tween(btn, TweenInfo.new(0.1), {TextSize = 13})
                    end)
                    
                    local F = {}
                    function F:SetTitle(t) btn.Text = t end
                    return F
                end

                -- [TOGGLE]
                function SecFuncs:Toggle(TSettings)
                    local togCont = MakeElement(36)
                    AddTitle(togCont, TSettings.Title)
                    
                    local btn = Instance.new("TextButton", togCont)
                    btn.Size = UDim2.fromScale(1,1)
                    btn.BackgroundTransparency = 1
                    btn.Text = ""
                    
                    local switchBg = Instance.new("Frame", togCont)
                    switchBg.Size = UDim2.fromOffset(36, 18)
                    switchBg.Position = UDim2.new(1, -46, 0.5, -9)
                    switchBg.BackgroundColor3 = THEME.SurfaceDark
                    Instance.new("UICorner", switchBg).CornerRadius = UDim.new(1,0)
                    
                    local knob = Instance.new("Frame", switchBg)
                    knob.Size = UDim2.fromOffset(14, 14)
                    knob.Position = UDim2.new(0, 2, 0.5, -7)
                    knob.BackgroundColor3 = THEME.TextMuted
                    Instance.new("UICorner", knob).CornerRadius = UDim.new(1,0)
                    
                    local toggled = TSettings.Default or false
                    
                    local function Update(state)
                        toggled = state
                        if toggled then
                            Tween(switchBg, TweenInfo.new(0.2), {BackgroundColor3 = THEME.Accent})
                            Tween(knob, TweenInfo.new(0.2), {Position = UDim2.new(1, -16, 0.5, -7), BackgroundColor3 = Color3.new(1,1,1)})
                        else
                            Tween(switchBg, TweenInfo.new(0.2), {BackgroundColor3 = THEME.SurfaceDark})
                            Tween(knob, TweenInfo.new(0.2), {Position = UDim2.new(0, 2, 0.5, -7), BackgroundColor3 = THEME.TextMuted})
                        end
                        SafeCallback(TSettings.Callback, toggled)
                    end
                    
                    Update(toggled)
                    btn.MouseButton1Click:Connect(function() Update(not toggled) end)
                    
                    local F = {}
                    function F:Set(v) Update(v) end
                    return F
                end

                -- [SLIDER]
                function SecFuncs:Slider(SSettings)
                    local slidCont = MakeElement(46)
                    AddTitle(slidCont, SSettings.Title).Size = UDim2.new(1, -10, 0, 20)
                    
                    local valLbl = Instance.new("TextLabel", slidCont)
                    valLbl.Size = UDim2.new(0, 40, 0, 20)
                    valLbl.Position = UDim2.new(1, -50, 0, 0)
                    valLbl.BackgroundTransparency = 1
                    valLbl.Text = tostring(SSettings.Default or SSettings.Minimum)
                    valLbl.Font = THEME.FontBold
                    valLbl.TextColor3 = THEME.Accent
                    valLbl.TextSize = 12
                    valLbl.TextXAlignment = Enum.TextXAlignment.Right
                    
                    local bar = Instance.new("Frame", slidCont)
                    bar.Size = UDim2.new(1, -20, 0, 4)
                    bar.Position = UDim2.new(0, 10, 0, 30)
                    bar.BackgroundColor3 = THEME.SurfaceDark
                    Instance.new("UICorner", bar).CornerRadius = UDim.new(1,0)
                    
                    local fill = Instance.new("Frame", bar)
                    fill.Size = UDim2.new(0,0,1,0)
                    fill.BackgroundColor3 = THEME.Accent
                    Instance.new("UICorner", fill).CornerRadius = UDim.new(1,0)
                    
                    local min, max = SSettings.Minimum, SSettings.Maximum
                    local value = SSettings.Default or min
                    
                    local function Update(input)
                        local sizeX = bar.AbsoluteSize.X
                        local pct = math.clamp((input.Position.X - bar.AbsolutePosition.X) / sizeX, 0, 1)
                        value = math.floor(min + (max - min) * pct)
                        Tween(fill, TweenInfo.new(0.05), {Size = UDim2.new(pct, 0, 1, 0)})
                        valLbl.Text = tostring(value)
                        SafeCallback(SSettings.Callback, value)
                    end
                    
                    local pct = (value - min) / (max - min)
                    fill.Size = UDim2.new(pct, 0, 1, 0)
                    
                    local btn = Instance.new("TextButton", bar)
                    btn.Size = UDim2.fromScale(1,1)
                    btn.BackgroundTransparency = 1
                    btn.Text = ""
                    
                    local dragging = false
                    btn.InputBegan:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then
                            dragging = true
                            Update(input)
                        end
                    end)
                    UserInputService.InputEnded:Connect(function(input)
                        if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end
                    end)
                    UserInputService.InputChanged:Connect(function(input)
                        if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then Update(input) end
                    end)
                    
                    local F = {}
                    function F:Set(v)
                        value = math.clamp(v, min, max)
                        local p = (value - min) / (max - min)
                        Tween(fill, TweenInfo.new(0.2), {Size = UDim2.new(p, 0, 1, 0)})
                        valLbl.Text = tostring(value)
                        SafeCallback(SSettings.Callback, value)
                    end
                    return F
                end

                -- [DROPDOWN] (Fix Layout issue)
                function SecFuncs:Dropdown(DSettings)
                    local dropCont = MakeElement(36)
                    dropCont.ClipsDescendants = true
                    
                    local title = AddTitle(dropCont, DSettings.Title)
                    
                    local current = DSettings.Default or "..."
                    local selectedLbl = Instance.new("TextLabel", dropCont)
                    selectedLbl.Size = UDim2.new(0, 100, 0, 36)
                    selectedLbl.Position = UDim2.new(1, -130, 0, 0)
                    selectedLbl.Text = current
                    selectedLbl.Font = THEME.FontSemi
                    selectedLbl.TextColor3 = THEME.TextMuted
                    selectedLbl.TextXAlignment = Enum.TextXAlignment.Right
                    selectedLbl.BackgroundTransparency = 1
                    
                    local arrow = Instance.new("ImageLabel", dropCont)
                    arrow.Size = UDim2.fromOffset(14, 14)
                    arrow.Position = UDim2.new(1, -24, 0.5, -7)
                    arrow.BackgroundTransparency = 1
                    arrow.Image = "rbxassetid://6034818372"
                    arrow.ImageColor3 = THEME.TextMuted
                    
                    local btn = Instance.new("TextButton", dropCont)
                    btn.Size = UDim2.fromScale(1,1)
                    btn.BackgroundTransparency = 1
                    btn.Text = ""
                    
                    local listFrame = Instance.new("Frame", dropCont)
                    listFrame.Size = UDim2.new(1, -10, 0, 0)
                    listFrame.Position = UDim2.new(0, 5, 0, 36) -- Start below Title
                    listFrame.BackgroundTransparency = 1
                    
                    local layout = Instance.new("UIListLayout", listFrame)
                    layout.Padding = UDim.new(0, 4)
                    
                    local expanded = false
                    
                    local function Refresh()
                        for _, c in pairs(listFrame:GetChildren()) do
                            if c:IsA("TextButton") then c:Destroy() end
                        end
                        for _, opt in ipairs(DSettings.Options) do
                            local b = Instance.new("TextButton", listFrame)
                            b.Size = UDim2.new(1, 0, 0, 24)
                            b.BackgroundColor3 = THEME.SurfaceDark
                            b.Text = opt
                            b.TextColor3 = THEME.TextMuted
                            b.Font = THEME.FontNormal
                            b.TextSize = 12
                            Instance.new("UICorner", b).CornerRadius = UDim.new(0, 4)
                            
                            b.MouseButton1Click:Connect(function()
                                current = opt
                                selectedLbl.Text = opt
                                expanded = false
                                Tween(dropCont, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, 36)})
                                Tween(arrow, TweenInfo.new(0.2), {Rotation = 0})
                                SafeCallback(DSettings.Callback, opt)
                            end)
                        end
                        listFrame.Size = UDim2.new(1, -10, 0, #DSettings.Options * 28)
                    end
                    Refresh()
                    
                    btn.MouseButton1Click:Connect(function()
                        expanded = not expanded
                        Tween(arrow, TweenInfo.new(0.2), {Rotation = expanded and 180 or 0})
                        Tween(dropCont, TweenInfo.new(0.2), {Size = UDim2.new(1, 0, 0, expanded and (36 + listFrame.Size.Y.Offset + 5) or 36)})
                    end)
                    
                    local F = {}
                    function F:Refresh(list)
                        DSettings.Options = list
                        Refresh()
                    end
                    function F:Set(v)
                        current = v
                        selectedLbl.Text = v
                    end
                    return F
                end

                -- [PARAGRAPH] (New Style)
                function SecFuncs:Paragraph(PSettings)
                    local parCont = MakeElement(0)
                    parCont.AutomaticSize = Enum.AutomaticSize.Y
                    parCont.BackgroundTransparency = 1
                    
                    -- Remove default stroke, add dedicated one
                    parCont.UIStroke:Destroy()
                    
                    local frame = Instance.new("Frame", parCont)
                    frame.Size = UDim2.new(1, 0, 0, 0)
                    frame.AutomaticSize = Enum.AutomaticSize.Y
                    frame.BackgroundColor3 = THEME.Background
                    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)
                    
                    local str = Instance.new("UIStroke", frame)
                    str.Color = THEME.StrokeGlow
                    str.Transparency = 0.6
                    
                    local title = Instance.new("TextLabel", frame)
                    title.Text = PSettings.Title or "Header"
                    title.Font = THEME.FontBold
                    title.TextSize = 14
                    title.TextColor3 = THEME.Accent
                    title.Size = UDim2.new(1, -16, 0, 20)
                    title.Position = UDim2.new(0, 8, 0, 6)
                    title.BackgroundTransparency = 1
                    title.TextXAlignment = Enum.TextXAlignment.Left
                    
                    local desc = Instance.new("TextLabel", frame)
                    desc.Text = PSettings.Desc or "Content goes here..."
                    desc.Font = THEME.FontNormal
                    desc.TextSize = 13
                    desc.TextColor3 = THEME.Text
                    desc.Size = UDim2.new(1, -16, 0, 0)
                    desc.Position = UDim2.new(0, 8, 0, 26)
                    desc.AutomaticSize = Enum.AutomaticSize.Y
                    desc.BackgroundTransparency = 1
                    desc.TextXAlignment = Enum.TextXAlignment.Left
                    desc.TextWrapped = true
                    
                    Instance.new("UIPadding", frame).PaddingBottom = UDim.new(0, 8)
                end

                -- [INPUT]
                function SecFuncs:Input(ISettings)
                    local inpCont = MakeElement(36)
                    AddTitle(inpCont, ISettings.Title)
                    
                    local box = Instance.new("TextBox", inpCont)
                    box.Size = UDim2.new(0, 100, 0, 20)
                    box.Position = UDim2.new(1, -110, 0.5, -10)
                    box.BackgroundColor3 = THEME.SurfaceDark
                    box.Text = ISettings.Default or ""
                    box.PlaceholderText = "..."
                    box.TextColor3 = THEME.Text
                    box.Font = THEME.FontNormal
                    box.TextSize = 12
                    
                    Instance.new("UICorner", box).CornerRadius = UDim.new(0, 4)
                    
                    box.FocusLost:Connect(function()
                        SafeCallback(ISettings.Callback, box.Text)
                    end)
                end

                return SecFuncs
            end
            
            return TabFuncs
        end
        return GroupFuncs
    end

    --// NOTIFICATION SYSTEM (Slide-in Style)
    function WindowFunctions:Notify(NSettings)
        local card = Instance.new("Frame")
        card.Size = UDim2.new(1, 0, 0, 50)
        card.Position = UDim2.new(1, 20, 0, 0) -- Start off-screen
        card.BackgroundColor3 = THEME.Background
        card.Parent = notifContainer
        
        Instance.new("UICorner", card).CornerRadius = UDim.new(0, 8)
        
        local stroke = Instance.new("UIStroke", card)
        stroke.Color = THEME.StrokeGlow
        stroke.Transparency = 0.5
        
        -- Side Bar Accent
        local bar = Instance.new("Frame", card)
        bar.Size = UDim2.new(0, 4, 1, 0)
        bar.BackgroundColor3 = THEME.Accent
        Instance.new("UICorner", bar).CornerRadius = UDim.new(0, 2)
        
        local title = Instance.new("TextLabel", card)
        title.Text = NSettings.Title or "Notification"
        title.Font = THEME.FontBold
        title.TextSize = 14
        title.TextColor3 = THEME.Text
        title.Size = UDim2.new(1, -20, 0, 20)
        title.Position = UDim2.new(0, 12, 0, 6)
        title.BackgroundTransparency = 1
        title.TextXAlignment = Enum.TextXAlignment.Left
        
        local desc = Instance.new("TextLabel", card)
        desc.Text = NSettings.Desc or ""
        desc.Font = THEME.FontNormal
        desc.TextSize = 12
        desc.TextColor3 = THEME.TextMuted
        desc.Size = UDim2.new(1, -20, 0, 20)
        desc.Position = UDim2.new(0, 12, 0, 24)
        desc.BackgroundTransparency = 1
        desc.TextXAlignment = Enum.TextXAlignment.Left
        
        -- Animation In
        Tween(card, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Position = UDim2.new(0,0,0,0)})
        
        task.delay(NSettings.Duration or 3, function()
            -- Animation Out
            local t = Tween(card, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.In), {Position = UDim2.new(1, 20, 0, 0)})
            t.Completed:Wait()
            card:Destroy()
        end)
    end

    function WindowFunctions:Unload()
        macLib:Destroy()
    end

    return WindowFunctions
end

--// Demo
function MacLib:Demo()
    local Window = MacLib:Window({Title = "Chilli Interface v2"})
    local Group = Window:TabGroup()
    
    local Main = Group:Tab({Title = "Main Finder"})
    local Section = Main:Section({Title = "Automation"})
    
    Section:Toggle({
        Title = "Enable Auto Farm",
        Default = false,
        Callback = function(v) 
            print("Farm:", v) 
            Window:Notify({Title = "System", Desc = "Auto Farm: " .. tostring(v)})
        end
    })
    
    Section:Dropdown({
        Title = "Select Method",
        Options = {"Fast", "Legit", "Rage"},
        Callback = function(v) print(v) end
    })
    
    Section:Button({
        Title = "Force Save",
        Callback = function() 
            Window:Notify({Title = "Config", Desc = "Configuration Saved!"})
        end
    })
    
    local Visuals = Group:Tab({Title = "Visuals"})
    local VSec = Visuals:Section({Title = "ESP Settings"})
    
    VSec:Paragraph({
        Title = "Important Note",
        Desc = "Using ESP features carries a risk of detection. Use at your own risk."
    })
    
    VSec:Slider({
        Title = "Render Distance",
        Minimum = 100,
        Maximum = 5000,
        Default = 1000,
        Callback = function(v) end
    })
end

return MacLib
